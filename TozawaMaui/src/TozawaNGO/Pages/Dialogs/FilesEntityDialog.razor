@namespace TozawaNGO.Pages
@using ShareRazorClassLibrary.Helpers
@using ShareRazorClassLibrary.Models.Dtos
@using ShareRazorClassLibrary.Models.Enums
@using TozawaNGO.Shared
@inherits BaseDialog

<style>
    .mud-tooltip-root {
        margin-right: 5px;
    }
</style>

<MudDialog Class="tzModal">
    <DialogContent>
        @if (!string.IsNullOrEmpty(_error))
        {
            <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true" Class="my-2">@_error</MudAlert>
        }
        @if (Entity != null && Entity.Attachments != null && Entity.Attachments.Count > 0)
        {
            <MudTable Breakpoint="Breakpoint.Xs" Style="max-height: 350px; overflow: scroll;" T="FileAttachmentDto"
                Striped="true" RowClassFunc="@SelectedRowClassFunc" CustomHeader="true" Dense="true" Hover="true"
                Items="@_attachments" OnRowClick="RowClickEvent" @bind-SelectedItem="_selectedItem"
                RowClass="cursor-pointer">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">
                        Total: @Entity.Attachments.Count
                    </MudText>
                    <MudSpacer />
                    <MudTextField T="string" DebounceInterval="500" Margin="Margin.Dense" @bind-Value="_searchString"
                        OnDebounceIntervalElapsed="s => OnSearch(s)" Placeholder="@Translate(SystemTextId.SearchText)"
                        Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                        Class="mt-0">
                    </MudTextField>
                </ToolBarContent>
                <ColGroup>
                    <MudHidden Breakpoint="Breakpoint.Xs">
                        <col style="width: 10%;" />
                        <col style="width: 30%;" />
                        <col style="width: 20%;" />
                        <col style="width: 20%;" />
                        <col style="width: 15%;" />
                        <col style="width: 5%;" />
                    </MudHidden>
                </ColGroup>
                <HeaderContent>
                    <MudTh>
                        <MudIcon Icon="@Icons.Material.Filled.CloudDownload"></MudIcon>
                    </MudTh>
                    <MudTh>
                        <MudIcon Icon="@Icons.Material.Filled.AttachFile"></MudIcon>
                    </MudTh>
                    <MudTh>
                        <SystemText TextId="@SystemTextId.Name" FallbackText="Name">
                        </SystemText>
                    </MudTh>
                    <MudTh>
                        <SystemText TextId="@SystemTextId.AttachmentType" FallbackText="Attachment type"></SystemText>
                    </MudTh>
                    <MudTh>
                        <SystemText TextId="@SystemTextId.Filesize" FallbackText="Filesize">
                        </SystemText>
                    </MudTh>
                    <MudTh>
                        <SystemText TextId="@SystemTextId.Delete" FallbackText="Delete">
                        </SystemText>
                    </MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="@(GetLabel(SystemTextId.Download, "Download"))">
                        <MudIconButton Disabled="@_onProgress" Icon="@Icons.Material.Filled.Download"
                            @onclick="() => Download(context)">
                        </MudIconButton>
                    </MudTd>
                    <MudTd DataLabel="@(GetLabel(SystemTextId.File, "File"))">
                        @if (!string.IsNullOrEmpty(context.MiniatureBlobUrl))
                        {
                            var thumb = "data:image/png;base64," + context.MiniatureBlobUrl;
                            <MudTooltip>
                                <ChildContent>
                                    <img src="@thumb" height="@_thumbnailSize" width="@_thumbnailSize" />
                                </ChildContent>
                                <TooltipContent>
                                    <img src="@thumb" />
                                </TooltipContent>
                            </MudTooltip>
                        }
                        else
                        {
                            <MudIconButton Icon=@GetFileTypeIcon(context)></MudIconButton>
                        }
                    </MudTd>
                    <MudTd DataLabel="@(GetLabel(SystemTextId.Name, "Name"))">@context.Name</MudTd>
                    <MudTd DataLabel="@(GetLabel(SystemTextId.AttachmentType, "File type"))">
                        @context.FileAttachmentType
                    </MudTd>
                    <MudTd DataLabel="@(GetLabel(SystemTextId.Filesize, "Size"))">@(Math.Round(context.Size / 1000, 2))kb
                    </MudTd>
                    <MudTd DataLabel="@(GetLabel(SystemTextId.Delete, "Delete"))">
                        <MudIconButton Disabled="@DisabledUploadFiles()" Icon="@Icons.Material.Filled.Delete"
                            @onclick="() => Delete(context)"></MudIconButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <SystemText TextId="@SystemTextId.NoAttachmentsExists" FallbackText="Entity contains no attachments">
            </SystemText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Disabled="@_onProgress" Color="Color.Primary" OnClick="Add" Variant="Variant.Filled">
            <SystemText TextId="@SystemTextId.Close" FallbackText="Close"></SystemText>
        </MudButton>
        <MudSpacer />
        <MudSelect Disabled="@_onProgress" Style="@($"position: {"relative"}; bottom: {"11px"}")"
            @bind-Value="_attachmentType" AnchorOrigin="Origin.BottomCenter" Placeholder="Select an attachment type">
            @foreach (AttachmentType item in Enum.GetValues(typeof(AttachmentType)))
            {
                <MudSelectItem Value="@item">@item</MudSelectItem>
            }
        </MudSelect>
        <InputFile id="fileInput" accept="@FileValidator._validContentTypes" OnChange="UploadFiles" hidden multiple />
        <MudButton Disabled="@DisabledUploadFiles()" HtmlTag="label" Variant="Variant.Filled" Color="Color.Primary"
            StartIcon="@Icons.Material.Filled.CloudUpload" for="fileInput">
            <MudText>
                <SystemText TextId="@SystemTextId.FileUpload" FallbackText="Upload files"></SystemText>
            </MudText>
        </MudButton>
    </DialogActions>
</MudDialog>